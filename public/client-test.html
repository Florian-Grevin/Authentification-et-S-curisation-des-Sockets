<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Test Socket.IO</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
body { font-family: sans-serif; padding: 20px; }
.log { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: scroll; }
nav a { margin-right: 15px; }
</style>
</head>
<body>

<!-- ðŸ”— Barre de navigation simple -->
<nav>
    <a href="/login.html">Connexion</a>
    <a href="/register.html">Inscription</a>
    <a href="#" onclick="logout()">DÃ©connexion</a>
</nav>

<h1>Console Client Socket.IO</h1>

<button onclick="sendPing()">Envoyer PING</button>
<button onclick="sendChat()">ðŸ’¬ Parler dans General</button>

<div id="logs" class="log"></div>

<script>
const socket = io('http://localhost:3000', {
    withCredentials: true
});

const logDiv = document.getElementById('logs');

function addLog(message) {
    const p = document.createElement('p');
    p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logDiv.appendChild(p);
}

window.addEventListener('load', async () => {
    try {
        const response = await fetch('/api/messages/general', {
            method: 'GET',
            credentials: 'include'
        });

        const messages = await response.json();

        messages.forEach(msg => {
            addLog(`[${msg.sender?.username ?? "??"}] : ${msg.content}`);
        });
    } catch (err) {
        console.error("Erreur fetch:", err);
        addLog("Impossible de charger l'historique.");
    }
});

socket.on('connect', () => {
    addLog(`ConnectÃ© au serveur avec l'ID : ${socket.id}`);
});

socket.on("connect_error", (err) => {
    addLog("User not connected : " + err.message);
});

socket.on('new_message', (data) => {
    addLog(`[${data.from}] : ${data.content}`);
});

socket.on('notification', (data) => {
    addLog(`[PRIVÃ‰] ${data.from} : ${data.text}`);
});

socket.on('my_pong', (data) => {
    addLog(`PONG reÃ§u : ${data.text}`);
});


// ðŸ”¥ DÃ©connexion
async function logout() {
    await fetch('/logout', {
        method: 'POST',
        credentials: 'include'
    });
    window.location.reload();
}

function sendPing() {
    addLog('Envoi de "ping"...');
    socket.emit('my_ping', { text: 'Hello Server!' });
}

function sendChat() {
    const text = prompt("Votre message :");
    if (text) {
        socket.emit('send_message', { content: text });
    }
}
</script>

</body>
</html>
